load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "artifact",
    srcs = [
        "api_client.go",
        "artifactory_downloader.go",
        "artifactory_uploader.go",
        "azure_blob.go",
        "azure_blob_downloader.go",
        "azure_blob_uploader.go",
        "batch_creator.go",
        "bk_uploader.go",
        "download.go",
        "download_unix.go",
        "downloader.go",
        "gs_downloader.go",
        "gs_uploader.go",
        "s3.go",
        "s3_downloader.go",
        "s3_uploader.go",
        "searcher.go",
        "uploader.go",
    ],
    importpath = "github.com/buildkite/agent/v3/internal/artifact",
    visibility = ["//:__subpackages__"],
    deps = [
        "//api",
        "//internal/agenthttp",
        "//internal/awslib",
        "//internal/experiments",
        "//internal/mime",
        "//logger",
        "//version",
        "@com_github_aws_aws_sdk_go_v2//aws",
        "@com_github_aws_aws_sdk_go_v2_config//:config",
        "@com_github_aws_aws_sdk_go_v2_feature_s3_manager//:manager",
        "@com_github_aws_aws_sdk_go_v2_service_s3//:s3",
        "@com_github_aws_aws_sdk_go_v2_service_s3//types",
        "@com_github_aws_smithy_go//transport/http",
        "@com_github_azure_azure_sdk_for_go_sdk_azidentity//:azidentity",
        "@com_github_azure_azure_sdk_for_go_sdk_storage_azblob//:azblob",
        "@com_github_azure_azure_sdk_for_go_sdk_storage_azblob//sas",
        "@com_github_azure_azure_sdk_for_go_sdk_storage_azblob//service",
        "@com_github_buildkite_roko//:roko",
        "@com_github_dustin_go_humanize//:go-humanize",
        "@dev_drjosh_zzglob//:zzglob",
        "@org_golang_google_api//googleapi",
        "@org_golang_google_api//option",
        "@org_golang_google_api//storage/v1:storage",
        "@org_golang_x_oauth2//google",
    ] + select({
        "@rules_go//go/platform:aix": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:android": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:darwin": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:dragonfly": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:freebsd": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:illumos": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:ios": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:linux": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:netbsd": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:openbsd": [
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:solaris": [
            "@org_golang_x_sys//unix",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "artifact_test",
    srcs = [
        "artifactory_downloader_test.go",
        "artifactory_uploader_test.go",
        "azure_blob_test.go",
        "bk_uploader_test.go",
        "download_test.go",
        "downloader_test.go",
        "gs_uploader_test.go",
        "s3_downloader_test.go",
        "s3_test.go",
        "s3_uploader_test.go",
        "searcher_test.go",
        "uploader_test.go",
    ],
    embed = [":artifact"],
    deps = [
        "//api",
        "//internal/experiments",
        "//logger",
        "@com_github_aws_aws_sdk_go_v2//aws",
        "@com_github_aws_aws_sdk_go_v2_service_s3//types",
        "@com_github_google_go_cmp//cmp",
        "@com_github_google_go_cmp//cmp/cmpopts",
        "@com_github_stretchr_testify//assert",
    ],
)
